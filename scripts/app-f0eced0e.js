"use strict";angular.module("stank",["ngAnimate","ngCookies","ngTouch","ngSanitize","ngResource","ngRoute","ngMaterial","pouchdb","stank.game"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"app/main/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("stank").controller("NavbarCtrl",["$scope",function(t){t.date=new Date}]),angular.module("stank.game",[]).directive("gameCanvas",["$injector",function(){var t=function(t){console.log("linkFn"),t.game=new Phaser.Game(t.width,t.height,Phaser.AUTO,"game-canvas"),console.log("game engine create"),t.onInit({game:t.game})};return{scope:{onInit:"&",width:"=",height:"="},restrict:"E",template:'<div id="game-canvas" style="height: 100vh;overflow: hidden"></div>',link:t}}]);var __extends=this.__extends||function(t,e){function a(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);a.prototype=e.prototype,t.prototype=new a},TankGame;!function(t){var e;!function(t){function e(t){i=t.add.group();for(var e=0;10>e;e++){var a=i.create(0,0,"kaboom",[0],!1);a.anchor.setTo(.5,.5),a.animations.add("kaboom")}}function a(t,e){var a=i.getFirstExists(!1);a.reset(t,e),a.play("kaboom",30,!1,!0)}var i;t.init=e,t.start=a}(e||(e={}));var a;!function(t){function e(t,e){n=t,o=t.add.group(),o.enableBody=!0,o.physicsBodyType=Phaser.Physics.ARCADE,o.createMultiple(e,"bullet",0,!1),o.setAll("anchor.x",.5),o.setAll("anchor.y",.5),o.setAll("outOfBoundsKill",!0),o.setAll("checkWorldBounds",!0)}function a(t,e,a){n.physics.arcade.overlap(o,t,e,null,a)}function i(t,e,a){var i=o.getFirstDead();i.reset(t,e),i.rotation=n.physics.arcade.moveToObject(i,a,500)}function s(){return o.countDead()}var n,o;t.init=e,t.testHit=a,t.fire=i,t.countDead=s}(a||(a={}));var i;!function(t){function e(t,e){n=t,o=t.add.group(),o.enableBody=!0,o.physicsBodyType=Phaser.Physics.ARCADE,o.createMultiple(e,"bullet",0,!1),o.setAll("anchor.x",.5),o.setAll("anchor.y",.5),o.setAll("outOfBoundsKill",!0),o.setAll("checkWorldBounds",!0)}function a(t,e,a){n.physics.arcade.overlap(o,t,e,null,a)}function i(t,e,a){var i=o.getFirstExists(!1);i.reset(t,e),i.rotation=n.physics.arcade.moveToPointer(i,500,a,0)}function s(){return o.countDead()}var n,o;t.init=e,t.testHit=a,t.fire=i,t.countDead=s}(i||(i={}));var s=function(){function t(t,e){this.health=3,this.fireRate=1e3,this.nextFire=0,this.alive=!0,this.game=t,this.player=e,this.x=t.world.randomX,this.y=t.world.randomY,this.shadow=t.add.sprite(this.x,this.y,"enemy","shadow"),this.tank=t.add.sprite(this.x,this.y,"enemy","tank1"),this.turret=t.add.sprite(this.x,this.y,"enemy","turret"),this.shadow.anchor.set(.5),this.tank.anchor.set(.5),this.turret.anchor.set(.3,.5),t.physics.enable(this.tank,Phaser.Physics.ARCADE),this.tank.body.immovable=!1,this.tank.body.collideWorldBounds=!0,this.tank.body.bounce.setTo(1,1),this.tank.angle=t.rnd.angle(),t.physics.arcade.velocityFromRotation(this.tank.rotation,100,this.tank.body.velocity)}return t.prototype.damage=function(){return this.health-=1,this.health<=0?(this.alive=!1,this.shadow.kill(),this.tank.kill(),this.turret.kill(),!0):!1},t.prototype.update=function(){this.x=this.tank.x,this.y=this.tank.y,this.shadow.x=this.tank.x,this.shadow.y=this.tank.y,this.shadow.rotation=this.tank.rotation,this.turret.x=this.tank.x,this.turret.y=this.tank.y,this.turret.rotation=this.game.physics.arcade.angleBetween(this.tank,this.player),this.game.physics.arcade.distanceBetween(this.tank,this.player)<300&&this.game.time.now>this.nextFire&&a.countDead()>0&&(this.nextFire=this.game.time.now+this.fireRate,a.fire(this.turret.x,this.turret.y,this.player))},t.prototype.bulletHitEnemy=function(t,a){a.kill();var i=this.damage();i&&e.start(this.tank.x,this.tank.y)},t}(),n=function(){function t(t){this.nextFire=0,this.fireRate=1e3,this.currentSpeed=0,this.game=t,this.tank=t.add.sprite(0,0,"tank","tank1"),this.tank.anchor.setTo(.5,.5),this.tank.animations.add("move",["tank1","tank2","tank3","tank4","tank5","tank6"],20,!0),t.physics.enable(this.tank,Phaser.Physics.ARCADE),this.tank.body.drag.set(.2),this.tank.body.maxVelocity.setTo(400,400),this.tank.body.collideWorldBounds=!0,this.turret=t.add.sprite(0,0,"tank","turret"),this.turret.anchor.setTo(.3,.5),this.shadow=t.add.sprite(0,0,"tank","shadow"),this.shadow.anchor.setTo(.5,.5),this.tank.bringToTop(),this.turret.bringToTop()}return t.prototype.update=function(){a.testHit(this.tank,this.bulletHitPlayer,this),this.shadow.x=this.tank.x,this.shadow.y=this.tank.y,this.shadow.rotation=this.tank.rotation,this.turret.x=this.tank.x,this.turret.y=this.tank.y,this.turret.rotation=this.game.physics.arcade.angleToPointer(this.turret)},t.prototype.bulletHitPlayer=function(t,e){e.kill()},t.prototype.fire=function(){this.game.time.now>this.nextFire&&i.countDead()>0&&(this.nextFire=this.game.time.now+this.fireRate,i.fire(this.turret.x,this.turret.y,this.game.input.activePointer))},t}(),o=function(t){function o(e){t.call(this),this.enemies=[],this.game=e}return __extends(o,t),o.prototype.removeLogo=function(){this.game.input.onDown.remove(this.removeLogo,this),this.logo.kill()},o.prototype.initEnemy=function(t,e){var a=20;this.enemiesAlive=20;for(var i=0;a>i;i++){var n=new s(t,e);this.enemies.push(n)}},o.prototype.preload=function(){console.log("PHASER: preload"),this.game.load.atlas("tank","assets/tanks/tanks.png","assets/tanks/tanks.json"),this.game.load.atlas("enemy","assets/tanks/enemy-tanks.png","assets/tanks/tanks.json"),this.game.load.image("logo","assets/tanks/logo.png"),this.game.load.image("bullet","assets/tanks/bullet.png"),this.game.load.image("earth","assets/tanks/scorched_earth.png"),this.game.load.spritesheet("kaboom","assets/tanks/explosion.png",64,64,23)},o.prototype.create=function(){console.log("PHASER: create"),this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.scale.pageAlignHorizontally=!0,this.game.scale.pageAlignVertically=!0,this.game.world.setBounds(-1e3,-1e3,2e3,2e3),this.land=this.game.add.tileSprite(0,0,800,600,"earth"),this.land.fixedToCamera=!0,i.init(this.game,30),a.init(this.game,100),e.init(this.game),this.player=new n(this.game),this.initEnemy(this.game,this.player.tank),this.logo=this.game.add.sprite(0,200,"logo"),this.logo.fixedToCamera=!0,this.game.input.onDown.add(this.removeLogo,this),this.game.camera.follow(this.player.tank),this.game.camera.deadzone=new Phaser.Rectangle(150,150,500,300),this.game.camera.focusOnXY(0,0),this.cursors=this.game.input.keyboard.createCursorKeys()},o.prototype.update=function(){this.enemiesAlive=0;for(var t=0;t<this.enemies.length;t++)this.enemies[t].alive&&(this.enemiesAlive++,this.game.physics.arcade.collide(this.player.tank,this.enemies[t].tank),i.testHit(this.enemies[t].tank,this.enemies[t].bulletHitEnemy,this.enemies[t]),this.enemies[t].update());this.cursors.left.isDown?this.player.tank.angle-=4:this.cursors.right.isDown&&(this.player.tank.angle+=4),this.cursors.up.isDown?this.player.currentSpeed=300:this.player.currentSpeed>0&&(this.player.currentSpeed-=4),this.player.currentSpeed>0&&this.game.physics.arcade.velocityFromRotation(this.player.tank.rotation,this.player.currentSpeed,this.player.tank.body.velocity),this.land.tilePosition.x=-this.game.camera.x,this.land.tilePosition.y=-this.game.camera.y,this.player.update(),this.game.input.activePointer.isDown&&this.player.fire()},o.prototype.render=function(){this.game.debug.text("Enemies: "+this.enemiesAlive+" / "+this.enemies.length,32,32)},o}(Phaser.State);t.GameState=o}(TankGame||(TankGame={})),angular.module("stank").factory("TankGame",function(){return TankGame.GameState}),angular.module("stank").controller("MainCtrl",["$scope","$log","pouchDB","TankGame","$interval",function(t,e,a,i,s){t.enemies=i.enemies,t.game_init=function(e){t.game=e,t.game.state.add("main",new i(e)),t.game.state.start("main",!0,!0)},s(function(){t.enemies=i.enemies},1e3)}]),angular.module("stank").run(["$templateCache",function(t){t.put("app/main/main.html",'<game-canvas on-init="game_init(game)" id="game-view" width="800" height="600"></game-canvas>'),t.put("app/components/navbar/navbar.html",'<md-toolbar layout="row" layout-align="center center" ng-controller="NavbarCtrl"><md-button>Tank</md-button><section flex="" layout="row" layout-align="left center"><md-button href="#" class="md-raised">Home</md-button><md-button href="#" class="md-raised">About</md-button><md-button href="#" class="md-raised">Contact</md-button></section><md-button href="#">Current date: {{ date | date:\'yyyy-MM-dd\' }}</md-button></md-toolbar>')}]);